<!DOCTYPE html>

<html>
<head>

<title>Blog&nbsp;|&nbsp;Arthur Ozga</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">

<!-- The loading of KaTeX is deferred to speed up page rendering -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>

<!-- To automatically render math in text elements, include the auto-render extension: -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>

</head>

<body>

<h2>Implementing a Dynamic Programming algorithm in Q</h2>
<p>
Curious about array-based programming, I recently started reading the online
book <a href="https://code.kx.com/q4m3/">Q For Mortals</a> by Jeffry Borror.

In an intrductory section, Borror covers an example of post-hoc optimal
execution in trading. The task is to pick the best time to buy then sell stock
to realize a maximum profit in a trading period, with up to one buy and sell allowed
(equivalently, we can require that exactly one trade occurs and you can buy/sell at the same time step),
assuming no market impact.

This is a typical phone interview level problem for software positions.
</p>
<p>
A slightly more advanced question is to ask for optimal execution with up to two,
three, or more non-overlapping buys and sells. Solutions, including the special case of two buys, can easily be found be found
<a
href="https://duckduckgo.com/?q=maximum+profit+buy+and+sell+at+most+twice&t=ffab&ia=web">online</a>.
</p>
<p>
I'd like to consider what an implementation in q/kdb, missing from the online
search results, would look like.
</p>
<p>
In the case of 1 buy and sell, Borror offers the following koan:
</p>
<pre>
q)n:10000000            / number of trade price ticks
q)pxs:90.0+(n?2001)%100 / initialize trades with uniform distribution [90.0,110.0]
q)max pxs-mins pxs      / fold max over a vector of incrementally best trades
</pre>
<p>
The precedence order in k is right-to-left,so let's go step by step:
<ol>
    <li> Take a vector of prices. </li>
    <li> Build a vector of the minimum price up to the current index</li>
    <li> Subtract this vector from the price at the current index, creating a vector of optimal trades ending at the current index</li>
    <li> Take the most profitable trade from the list</li>
</ol>
</p>
<p>
Let \(OE_k(P)\) denote a vector of the optimal optimal execution with \(k\) trades, given prices \(P\).
The entry \(OE_k(P)_i\) is the optimal result for a trade that sells the last trade at time \(i\).
</p>
<p>
We can see a straightforward mapping between the implementation and the following recurrence relation:
</p>
$$
\begin{aligned}
OE_1(P)_i
&= \max_{0 \leq j \leq i} \left\{ p_i - p_j \right\} \\
&= p_i - \min_{0 \leq j \leq i} \left\{ p_j \right\} \\
\end{aligned}
$$
For two trades, we want to pick an sale time \(j\), lock in the profit of the most profitable trade before that point,
and then add in the most profitable trade starting at the pivot. A recurrence expression is
$$
\begin{aligned}
OE_2(P)_i
&= \max_{0\leq j \leq i} \left\{ p_i - p_j + \max_{0 \leq l \leq j}OE_1(P)_l \right\} \\
&= p_i + \max_{0\leq j \leq i} \left\{ \max_{0 \leq l \leq j} OE_1(P)_l\ - p_j \right\}
\end{aligned}
$$
Perhaps the notation is suggestive to enough to show where this is going:
$$
\begin{aligned}
OE_{k+1}(P)_i
&= \max_{0\leq j \leq i} \left\{ p_i - p_j + \max_{0 \leq l \leq j}OE_k(P)_l \right\} \\
&= p_i + \max_{0\leq j \leq i} \left\{ \max_{0 \leq l \leq j} OE_k(P)_l\ - p_j \right\} \\
OE_0(P)_i &= 0 \\
OE_k(P)_0 &= 0.
\end{aligned}
$$
<p>
Do a sanity check that the recurrence relation holds for \(OE_1(P)_i\).
</p>
<p>
The code is a straightforward translation of the recurrence relations:
</p>
<pre>
q)pfts1:{[pxs] pxs-min pxs} / same as above, now as a bound function
q)pfts2:{[pxs] pxs+maxs (maxs pfts1[pxs]) - pxs}
q)pftsk:{[k;pxs] {[pxs;pftsl] pxs + maxs (maxs pftsl) - pxs}[pxs]/[k;pxs-pxs]}
q)
q)max pftsk[128;pxs] / example invocation
2560f
</pre>
<p>
Notice how succinct the code is. As an exercise, write out the step-by-step description of what the q code does (hint: learn about
<a href="https://code.kx.com/q4m3/6_Functions/#676-over-for-accumulation">over</a>).
</p>
<p>
A final note on complexity. It is plain to see that each iteration loops through the vector of \(n\) elements between 1 and 4n times, depending on whether the values are computed incrementally (for the factor of \(n\)) and whether the iteration through the elements is fused (for the 4 operations).
</p>
<p>
Here are timings on my machine (in millis) as \(k\) increases:
</p>
<pre>
q)\t max pftsk[1;pxs]
155
q)\t max pftsk[10;pxs]
1251
q)\t max pftsk[16;pxs]
1971
q)\t max pftsk[32;pxs]
3924
q)\t max pftsk[64;pxs]
7724
q)\t max pftsk[128;pxs]
15673
</pre>
<p>
indicating the complexity is linear in \(k\).
</p>
<p>
Here are timings on machine for fixed \(k\) as \(n\) increases:
</p>
<pre>
q)\t max pftsk[128;90.0+(1000?2001)%100]
3
q)\t max pftsk[128;90.0+(10000?2001)%100]
25
q)\t max pftsk[128;90.0+(100000?2001)%100]
156
q)\t max pftsk[128;90.0+(1000000?2001)%100]
1567
q)\t max pftsk[128;90.0+(10000000?2001)%100]
16090
q)\t max pftsk[128;90.0+(100000000?2001)%100]
'wsfull
m 0 1073745920
</pre>
<p>
The memory overflow occurs because I am using the (free) 32-bit version of q.
In any event, we can see the performance is more-or-less linear in \(n\) as well.
</p>

<h2>How to Rock the Stage</h2>

<p>
Back at Microsoft, I went to a seminar (they call them "courses") on the topic of public speaking,
taught by then distinguished engineer / tech evangelist <a href="https://www.docjamesw.com/">James Whittaker</a>.
In my experience, he was a pretty good speaker and knew how to work an audience, (TODO footnote: on that day, fresh hires and folks experiencing a mid-life/career crisis.)
So well that I was originally planning to transcribe notes from that seminar, but instead ended up watching another <a href="https://www.youtube.com/watch?v=uKtMwmWv6Q0">talk on public speaking</a> he gave a year earlier with <a href="https://www.medickinson.com/">Michelle Dickinson</a>

Notes from the latter:
</p>

<ul>
	<li>
		Why speak? To influence people.
		What better way to influence people than with effective stage presence?
	</li>
	<li>
		If you tell someone their own story, it will resonate.
		So, speak <b>for</b> your audience, not <b>to</b> them!
		James equates this to the old adage, "Show, don't tell."
		Saying "I", "me", and talking about your accomplishments is a great way to speak <b>to</b> the audience.
	</li>
	<li>
		A concept is an address -- the name of the place where details are filed away.
		Always give an address for the details.
		Forcing an emotional connection is a way to create an address. Some examples:
		<ul>
			<li>imprint with a sensory experience -- sound, visuals, taste, touch, smell.</li>
			<li>a shocking / visceral experience</li>
			<li>imprint with a common language / experience</li>
			<li>imprint with a surprising connection</li>
		</ul>
		<ul><li>
				(TODO: convert to footnote -- This idea meshes very well with the learning technique of chunking and attempting to retain ideas past the memory consolidation period (see <a href="https://en.wikipedia.org/wiki/Sleep_spindle">sleep spindles</a>) by forming connections to known ideas. More on this in another post.)
			</li></ul>
	</li>
	<li>
		You need to believe what you are saying to persuade.
		For whatever reason (subtle cues?), in an FMRI study, the speaker and listener's brains mirrored each others' activity (source?). This lends some credence to the idea that you need to be emotionally invested in the presentation in the way you want your audience to be invested.
	</li>
	<li>
		James has stories for important moments -- every project has a story.
		Train yourself to recognize stories. Be a collector, inventor, and hunter of them.
		They give you insight into the speaker's life.
	</li>

	<li>
		Don't bombard. Pick <b>one</b> message. Is it tweetable?
	</li>
	<li>
		<b>Preparation is not optional</b>. Preparation is personal.
		Some examples of personal habits:

		<ul>
			<li>practice with music to get a tempo</li>
			<li>practice when you will breathe</li>
			<li>practice by saying it out loud</li>
			<li>record yourself</li>
			<li>repeat the talk mentally over and over and over</li>
			<li>repeat the talk in bed</li>
			<li>practice the talk under increased pressure:</li>
			<ul>
				<li>tell the talk while naked in front of the mirror</li>
				<li>tell the talk to strangers</li>
			</ul>
		</ul>
	</li>
	<li>
		Practice by giving talks.
	</li>
	<li>
		Nerves: they are like birthday candles -- savor them because they don't come that often.
	</li>
	<li>
		Start strong! A talk is not a movie and the opening sentence is an upper bound on who will pay attention. An audience that has opted in will overlook some mistakes.
	</li>
	<li>
		Never turn your back to the audience.
	</li>
	<li>
		PowerPoint should never be more than a prop. Don't rely on it; you should be able to give the talk without any props. Always command the props, not the other way around (otherwise you are superfluous). The exception is videos -- you prepared them to takeover the stage.
	</li>
	<li>
		Accentuate the key phrases. They really matter.
		You can't do that while reading from a prompt.
	</li>
	<li>
		Pauses are important. Use them thoughtfully.
	</li>
	<li>
		Simple but deliberate stage movement and body language keeps the focus on the message.
		Keep hands open. Hitler gave talks with fists. Pointing can be considered aggressive.
		Standing behind a podium is too little stimulation. Dancing on the stage is too much.
	</li>
	<li>
		Only look at notes in conjunction with another action (eg: turning).
		Think of using illusions and misdirection to hide the use of notes.
	</li>
	<li>
		Be genuine. Use your natural personality.
		It makes you more relatable.
		You will polarize, that's okay.
		Even a persona is the personification of your goals and desires.
	</li>
	<li>
		Finish strong (just like you started)!
		Memories of an event tend to be colored by the average of the most extreme and last moments.
	</li>
</ul>

The actual talk manifests these ideas with plenty of examples and the talk itself adheres to these ideas throughout.
James' speaking has a great quality of connecting so many disparate concepts -- sometimes whimsically -- in a way that infects my mind a bit every time.
He kind of get's away with being an ass in a way where calling him out makes me more of an ass!


<h2>Squatting Technique</h2>

<p>
<b>UPDATE</b> (2020/04/01): Since going to a gym is currently ill-advised and I do not
have weights at home, I have been practicing technique using body weight. In
order to get the intensity up, I have been doing Arithmetic Progression Squats
(APS), which are more commonly known as 
<a href="https://www.menshealth.com/fitness/a19546566/death-by-air-squat-workout/">
    "death by air squat"
</a>. A nice feature of this workout is that the first few sets give time to warm up and
focus on perfecting technique. Also, the load on individual reps is low enough that
you can sense where you are over-underutilizing a muscle group before an injury
is imminent. I have not tried geometric progressions.
</p>

<p>
A friend of mine told me I was spending too much time learning how to squat rather than just doing it. They are probably right.
</p>

<p>
Unfortunately, I'd picked up the excellent 
<a href="https://aasgaardco.com/store/books-posters-dvd/books/starting-strength-basic-barbell-training"/><em>Starting Strength: Basic Barbell Training</em></a>, and I was not to be deterred in learning the safest technique to improve strength. Here are some of my notes on squatting:
</p>

<ul>
	<li>lifter + barbell center-of-mass should remain over mid foot</li>
	<li>a lower bar allows for a more horizontal back at the bottom</li>
	<li>front squats exert the butt more and hamstrings less</li>
	<li>the bar should sit under the spine of the scapula</li>
	<li>low-bar vs high-bar squats:</li>
	<ul>
		<li>higher hamstring load</li>
		<li>more horizontal back angle</li>
		<li>more open knee angle</li>
		<li>movement path is similar to dead lift &amp; power clean</li>
	</ul>
	<li>shoulder-width knees + 30&deg; toes + knees out &rArr; groin stretch and activation</li>
	<li>squat depth: hips go below level with top of patellas</li>
	<li>exercise: no weight squat</li>
	<ul>
		<li>back should be about 45&deg; at the bottom</li>
		<li>at the bottom, think hips up, not forward</li>
	</ul>
	<li>keep neck in natural alignment -- think of squeezing a tennis ball with chin</li>
	<li>eye-gaze: 4-5 feet in front of toes</li>
	<li>narrower hands &rArr; more posterior shoulder flexion and keep thoracic spine extended + straight</li>
	<li>wrists: hands above bar. They do not carry weight</li>
	<li>tighten muscles before lifting from rack</li>
	<li>always face towards the rack -- forwards when re-racking</li>
	<li>take only one step back from the rack</li>
</ul>

This is an incomplete summary of the 64 pages(!) devoted to the squat. Which of these did you find intuitive? Which were surprising?

<h2>Sending Shame Emails When Gaming</h2>

<p>
My brother asked me to alert him every time I start playing <emph>Magic the Gathering: Arena</emph>.
One way to do this is to send an email every time I start the game.
</p>
<p>
I looked up how to <a href="https://www.howtogeek.com/125045/how-to-easily-send-emails-from-the-windows-task-scheduler/">send emails programmatically on Windows</a> (the platform MTGA runs on).
I found a perl program called <em>sendemail</em> that does this.
There's an <a href="http://caspian.dotconf.net/menu/Software/SendEmail/">official-seeming page</a> from 2009, a <a href="http://freshmeat.sourceforge.net/projects/sendemail/">sourceforce page</a> which was last updated in 2009, and
a <a href="https://github.com/mogaal/sendemail">github page</a> last updated in 2012 which seems to be the same program. I picked the most recently edited of these three thinking it might have some fixes (or maybe a backdoor!).
After installing <a href="http://strawberryperl.com/">strawberry perl</a> and doing a naive invocation, I was met with:
</p>
<pre>
$ perl path/to/sendEmail -f "aozgaa AT gmail DOT com" -u "starting mtg arena" -t "aozgaa AT gmail DOT com" -s "smtp.gmail.com:587" -o tls=yes -xu "aozgaa AT gmail DOT com" -xp 'mypassword' -m "some message"
invalid SSL_version specified at /home/daedalus/perl5/lib/perl5/IO/Socket/SSL.pm line 728.
</pre>
<p>
Huh? It looks like this issue has been encountered <a href="https://unix.stackexchange.com/questions/53065/invalid-ssl-version-specified-at-usr-share-perl5-io-socket-ssl-pm-line-332">before</a>. So I tried a few things, and eventually this patch looked reasonable:
</p>
<pre>
$ git diff
diff --git a/sendEmail b/sendEmail
index 9f9392e..8a8dec2 100755
--- a/sendEmail
+++ b/sendEmail
@@ -1903,7 +1903,7 @@ else {
     if ($conf{'tls_server'} == 1 and $conf{'tls_client'} == 1 and $opt{'tls'} =~ /^(yes|auto)$/) {
         printmsg("DEBUG => Starting TLS", 2);
         if (SMTPchat('STARTTLS')) { quit($conf{'error'}, 1); }
-        if (! IO::Socket::SSL->start_SSL($SERVER, SSL_version => 'SSLv3 TLSv1')) {
+        if (! IO::Socket::SSL->start_SSL($SERVER)) {
             quit("ERROR => TLS setup failed: " . IO::Socket::SSL::errstr(), 1);
         }
         printmsg("DEBUG => TLS: Using cipher: ". $SERVER->get_cipher(), 3);
</pre>
<p>
(Note, it looks like this is necessary on both Windows and Linux). Now I get:
</p>
<pre>
$ perl /path/to/sendEmail -f "aozgaa AT gmail DOT com" -u "starting mtg arena" -t "aozgaa AT gmail DOT com" -s "smtp.gmail.com:587" -o tls=yes -xu "aozgaa AT gmail DOT com" -xp 'mypassword' -m "some message"
Mar 15 16:16:57 daedalus-arch sendEmail[56559]: ERROR => ERROR => SMTP-AUTH: Authentication to smtp.gmail.com:587 failed.
</pre>
<p>
So putting in my actual password (you didn't think it was that bad, did you?) didn't work.
I enabled IMAP in <a href="https://mail.google.com/mail/u/0/#settings/fwdandpop">gmail's settings</a>.
Stack Overflow stopped giving answers, so I continued searching and found <a href="https://support.google.com/accounts/answer/185833?hl=en">Google's password help</a> where I was reminded that I have 2-Factor authentication enabled.
So I needed to make an <a href="https://myaccount.google.com/apppasswords">app password</a>.
I chose a Windows password for mail because, well, that's what we're doing.
Finally, I used the app password, and now I can send an email to myself (or my brother!).
I then made a (powershell) script that sends an email then runs MTGA:
</p>
<pre>
perl /path/to/sendEmail -f "aozgaa AT gmail DOT com" -u "starting mtg arena" -t "aozgaa AT gmail DOT com" -s "smtp.gmail.com:587" -o tls=yes -xu "aozgaa AT gmail DOT com" -xp 'apppassword' -m "some message"

&"C:\Program Files (x86)\Wizards of the Coast\MTGA\MTGALauncher\MTGALauncher.exe"
</pre>

<p>
Now I can go back to feeding my addiction.
</p>

<h2>Resources for Building a Web Server</h2>

<strong>Exercise</strong>: pick a use-case (eg: static file server, streaming file server, database web server)
and implement the bare minimum to be able to interact with it using standard tools (eg: curl).
<br>
This means probably only supporting ipv4, HTTP/1.1 (1.2 is relatively complicated), and omitting most of the contents of the corresponding specs.
<br>
I am working on hosting my personal site on such a web server instead of github.io.
<br><br>

<ul>
<li><a href="https://beej.us/guide/bgnet/html/single/bgnet.html">Beej's Guide to Network Programming</a></li>
<li><a href="https://tools.ietf.org/html/rfc2616">rfc2616 -- http/1.1</a></li>
<li><a href="https://tools.ietf.org/html/rfc7231">rfc7231 -- http semantics and content</a></li>
<li><a href="http://www.kegel.com/c10k.html">The C10K Problem</a> (history and context)</li>
<li><a href="https://lwn.net/Articles/726917/">zero-copy networking</a></li>
<li><code>man man</code></li>
<li><code>man write</code></li>
<li><code>man epoll</code></li>
<li><code>man splice</code></li>
</ul>

</body>

</html>
